#!/bin/bash

#
# mragentconf uuid manta-url moray-url name-service-1 [name-service-2 ...]
# Reconfigures the Marlin agent with the specified URLs and name servers.
#

mac_arg0=$(basename $0)

function usage
{
	echo "usage: $mac_arg0 uuid mantaurl morayurl nameservice1 ..." >&2
	exit 2
}

function fail
{
	echo "$*" >&2
	exit 1
}

[[ $# -gt 3 ]] || usage

mac_serverid=$1
mac_manta_host=$2
mac_moray_host=$3
mac_root=$(dirname $0)/..
mac_zones_file=$mac_root/etc/marlinzones

mac_code="instanceUuid='$mac_serverid'; zonesFile='$mac_zones_file'"
mac_code="$mac_code; moray.url='tcp://$mac_moray_host:2020'"
mac_code="$mac_code; manta.host='$mac_manta_host'; manta.port=80"
mac_code="$mac_code; dns.nameservers = []"

shift 3
for ns in "$@"; do
	mac_code="$mac_code; dns.nameservers.push('$ns')"
done

json -e "$mac_code" < $mac_root/etc/agentconfig.coal.json > \
    $mac_root/etc/agentconfig.json || fail "failed to rewrite config"
svcadm disable -s marlin-agent || fail "failed to disable marlin-agent"
svcadm enable -s marlin-agent || fail "failed to enable marlin-agent"
