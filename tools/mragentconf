#!/bin/bash

#
# mragentconf manta-url moray-url name-service-1 [name-service-2 ...]
# Reconfigures the Marlin agent with the specified URLs and name servers.
#

mac_arg0=$(basename $0)

function usage
{
	echo "usage: $mac_arg0 mantaurl morayurl nameservice1 ..." >&2
	exit 2
}

function fail
{
	echo "$*" >&2
	exit 1
}

[[ $# -gt 2 ]] || usage

mac_serverid=$(sysinfo | json UUID)
mac_manta_host=$1
mac_moray_host=$2
mac_root=$(dirname $0)/..
mac_confdir=/opt/smartdc/marlin/etc

mac_code="instanceUuid='$mac_serverid'"
mac_code="$mac_code; moray.url='tcp://$mac_moray_host:2020'"
mac_code="$mac_code; manta.url='http://$mac_manta_host:80/'"
mac_code="$mac_code; dns.nameservers = []"

mkdir -p "$mac_confdir" || fail "failed to mkdir $mac_confdir"

shift 2
for ns in "$@"; do
	mac_code="$mac_code; dns.nameservers.push('$ns')"
done

json -e "$mac_code" < $mac_root/etc/agentconfig.coal.json > \
    $mac_confdir/agentconfig.json || fail "failed to rewrite config"
svcadm disable -st marlin-agent || fail "failed to disable marlin-agent"
svcadm enable -s marlin-agent || fail "failed to enable marlin-agent"
